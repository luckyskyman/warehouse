<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°½ê³  ë¬¼í’ˆì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .hidden { display: none !important; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: rgba(255,255,255,0.95); padding: 40px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); text-align: center; width: 90%; max-width: 400px; }
        .login-box h2 { margin-bottom: 20px; }
        .login-box .form-group { text-align: left; margin-bottom: 15px; }
        .login-box input { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; }
        .login-box button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        #login-error { color: red; margin-top: 10px; height: 1.2em; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { position: relative; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .header h1 { color: #333; text-align: center; font-size: 2.2em; margin-bottom: 10px; }
        #logout-button { position: absolute; top: 15px; right: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; backdrop-filter: blur(5px); }
        .tab:hover { background: rgba(255, 255, 255, 0.9); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .tab.active { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4); }
        .content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group button, .form-group textarea { padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; margin: 5px; }
        .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-info { color: white; }
        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .btn-info { background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%); }
        .btn-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%); }
        .btn-danger-sm { padding: 4px 10px; font-size: 12px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn-edit-master { background: none; border: none; cursor: pointer; font-size: 1em; margin-left: 8px; padding: 0 5px; vertical-align: middle; opacity: 0.6; }
        .btn-edit-master:hover { opacity: 1; transform: scale(1.2); }
        .search-container { position: relative; margin-bottom: 20px; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; width: 20px; height: 20px; }
        .search-bar { width: 100%; padding: 15px 15px 15px 45px; border: 2px solid #e1e5e9; border-radius: 25px; font-size: 16px; background: rgba(255, 255, 255, 0.9); transition: all 0.3s ease; }
        .search-bar:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e1e5e9; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        tfoot tr { background-color: #f8f9fa; font-weight: bold; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-in-stock { background: #d4edda; color: #155724; }
        .status-out-of-stock { background: #f8d7da; color: #721c24; }
        .status-ok { color: green; font-weight: bold; }
        .status-shortage { color: red; font-weight: bold; }
        .file-upload { border: 2px dashed #4facfe; border-radius: 10px; padding: 20px; text-align: center; margin: 10px 0; cursor: pointer; transition: all 0.3s ease; }
        .file-upload:hover { background: rgba(79, 172, 254, 0.1); }
        .file-upload h3 { margin-bottom: 8px; color: #333;}
        .file-upload p { font-size: 0.9em; color: #666; }
        .excel-section { background-color: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .excel-section h2 { margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.5); padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .stat-number { font-size: 2em; font-weight: 700; color: #333; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        .warehouse-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .zone-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .zone-title { font-size: 1.4em; font-weight: 700; margin-bottom: 20px; color: #333; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
        .subzone-item { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .subzone-title { font-weight: 600; }
        .floor-badges { display: flex; gap: 8px; }
        .floor-badge { padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; border: 2px solid transparent; }
        .floor-badge.occupied { background: #ffcdd2; color: #b71c1c; border-color: #ef9a9a; }
        .floor-badge.vacant { background: #e0e0e0; color: #616161; }
        #warehouseLayoutContainer .zone-management { background-color: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e1e5e9; }
        #warehouseLayoutContainer h3 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        #warehouseLayoutContainer .subzone-list { list-style-type: none; padding: 0; margin-top: 10px; }
        #warehouseLayoutContainer .subzone-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        #warehouseLayoutContainer .subzone-list li:last-child { border-bottom: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); width: 90%; max-width: 600px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-close { font-size: 2em; font-weight: 200; cursor: pointer; border: none; background: none; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body #historyList { list-style-type: none; max-height: 300px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .modal-body #historyList li { padding: 8px; border-bottom: 1px solid #eee; }
        .modal-body #historyList li:last-child { border-bottom: none; }
        .modal-footer { text-align: right; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2>ì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ ë¡œê·¸ì¸</h2>
            <form id="loginForm"><div class="form-group"><label for="username">ì•„ì´ë””</label><input type="text" id="username" required></div><div class="form-group"><label for="password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="password" required></div><div id="login-error"></div><button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button></form>
        </div>
    </div>

    <div class="container hidden" id="main-container">
        <div class="header"><h1>ğŸ­ ì°½ê³  ë¬¼í’ˆì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ</h1><div id="logout-button"><button class="btn btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button></div><div class="stats-grid"><div class="stat-card"><div class="stat-number" id="totalItems">0</div><div class="stat-label">ì´ ì¬ê³ ëŸ‰ (ea)</div></div><div class="stat-card"><div class="stat-number" id="inStockItems">0</div><div class="stat-label">ì´ í’ˆëª© ìˆ˜</div></div><div class="stat-card"><div class="stat-number" id="outStockCount">0</div><div class="stat-label">ì¶œê³  ì™„ë£Œ ê±´</div></div><div class="stat-card"><div class="stat-number" id="occupiedLocations">0</div><div class="stat-label">ì‚¬ìš© ì¤‘ì¸ ìœ„ì¹˜</div></div></div></div>
        
        <div class="tabs">
            <button class="tab" data-tab="bomCheck" data-role="admin viewer">âš™ï¸ ì„¤ì¹˜ê°€ì´ë“œë³„ ìì¬ í™•ì¸</button>
            <button class="tab" data-tab="inventory" data-role="admin viewer">ğŸ“¦ ì¬ê³ ê´€ë¦¬</button>
            <button class="tab" data-tab="inbound" data-role="admin">ğŸ“¥ ì…ê³ ê´€ë¦¬</button>
            <button class="tab" data-tab="outbound" data-role="admin">ğŸ“¤ ì¶œê³ ê´€ë¦¬</button>
            <button class="tab" data-tab="move" data-role="admin">ğŸ”„ ì´ë™ê´€ë¦¬</button>
            <button class="tab" data-tab="warehouse" data-role="admin viewer">ğŸª ì°½ê³ í˜„í™©</button>
            <button class="tab" data-tab="layout" data-role="admin">ğŸ”§ ì°½ê³  êµ¬ì¡° ê´€ë¦¬</button>
            <button class="tab" data-tab="excel" data-role="admin viewer">ğŸ“Š ì—‘ì…€ê´€ë¦¬</button>
        </div>
        
        <div id="bomCheck" class="content hidden">
            <h2>âš™ï¸ ì„¤ì¹˜ê°€ì´ë“œë³„ ìì¬ í™•ì¸</h2>
            <div class="form-group">
                <label for="guideSelect">ì„¤ì¹˜ê°€ì´ë“œ ì„ íƒ</label>
                <select id="guideSelect" onchange="checkBom()">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="table-container">
                <table id="bomTable">
                    <thead><tr><th>í•„ìš” ë¶€í’ˆì½”ë“œ</th><th>í’ˆëª…</th><th>í•„ìš”ìˆ˜ëŸ‰</th><th>í˜„ì¬ê³ </th><th>ìƒíƒœ</th></tr></thead>
                    <tbody id="bomBody"></tbody>
                </table>
            </div>
        </div>

        <div id="inventory" class="content hidden"><h2>ğŸ“¦ ì¬ê³  í˜„í™©</h2><div class="search-container"><svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10,18a8,8,0,1,1,8-8A8,8,0,0,1,10,18ZM10,4a6,6,0,1,0,6,6A6,6,0,0,0,10,4Z"/><path d="M21,22a1,1,0,0,1-.71-.29l-4-4a1,1,0,0,1,1.42-1.42l4,4a1,1,0,0,1,0,1.42A1,1,0,0,1,21,22Z"/></svg><input type="text" class="search-bar" id="searchInput" placeholder="ì œí’ˆì½”ë“œ, í’ˆëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰..."></div><div class="table-container"><table id="inventoryTable"><thead><tr><th>ì œí’ˆì½”ë“œ</th><th>í’ˆëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>ìˆ˜ëŸ‰</th><th>ìœ„ì¹˜</th><th>ìƒíƒœ</th><th>ì…ê³ ì¼</th><th>ì´ë ¥</th><th>ê´€ë¦¬</th></tr></thead><tbody id="inventoryBody"></tbody><tfoot id="inventoryTfoot"></tfoot></table></div></div>
        
        <div id="inbound" class="content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ“¥ ì…ê³  ê´€ë¦¬</h2>
                <button class="btn btn-info" onclick="openExchangeModal()">ğŸ“¦ êµí™˜ ëŒ€ê¸° ëª©ë¡ ë³´ê¸°</button>
            </div>
            <form id="inboundForm"><div class="form-grid"><div class="form-group"><label>ì œí’ˆì½”ë“œ</label><input type="text" id="inProductCode" list="product_code_list" required><datalist id="product_code_list"></datalist></div><div class="form-group"><label>í’ˆëª…</label><input type="text" id="inProductName" list="product_name_list" required><datalist id="product_name_list"></datalist></div><div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><select id="inCategory" required><option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="ì „ìì œí’ˆ">ì „ìì œí’ˆ</option><option value="ì˜ë¥˜">ì˜ë¥˜</option><option value="ì‹í’ˆ">ì‹í’ˆ</option><option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option><option value="ì‚°ì—…ìì¬">ì‚°ì—…ìì¬</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div><div class="form-group"><label id="inboundQuantityLabel">ìˆ˜ëŸ‰</label><div style="display: flex; gap: 20px; margin-bottom: 10px;"><label style="cursor:pointer; display:flex; align-items:center;"><input type="radio" name="inboundUnitType" value="box" onchange="updateInboundQuantityUI()" style="width:auto; margin-right:5px;"> ë°•ìŠ¤ë¡œ ì…ë ¥</label><label style="cursor:pointer; display:flex; align-items:center;"><input type="radio" name="inboundUnitType" value="ea" checked onchange="updateInboundQuantityUI()" style="width:auto; margin-right:5px;"> ë‚±ê°œ(EA)ë¡œ ì…ë ¥</label></div><div id="inboundQuantityInputsContainer"></div></div><div class="form-group"><label>êµ¬ì—­</label><select id="inZone" required></select></div><div class="form-group"><label>ì„¸ë¶€êµ¬ì—­</label><select id="inSubZone" required></select></div><div class="form-group"><label>ì¸µìˆ˜</label><select id="inFloor" required></select></div><div class="form-group"><label>ì…ê³ ì¼</label><input type="date" id="inDate" required></div></div><button type="submit" class="btn btn-primary">ì…ê³  ë“±ë¡</button></form>
        </div>

        <div id="outbound" class="content hidden"><h2>ğŸ“¤ ì¶œê³  ê´€ë¦¬</h2><div class="form-grid"><div class="form-group"><label>ì œí’ˆ ì„ íƒ</label><input type="text" id="outProductSelect" list="outbound_item_list" required><datalist id="outbound_item_list"></datalist></div><div class="form-group"><label>ì¶œê³  ìˆ˜ëŸ‰ (ea)</label><input type="number" id="outQuantity" min="1"></div>
        <div class="form-group"><label>ì¶œê³  ì‚¬ìœ </label><select id="outReason"><option value="ì¡°ë¦½ì¥ ì´ë™">ì¡°ë¦½ì¥ ì´ë™</option><option value="ì¶œê³  ë°˜í™˜">ì¶œê³  ë°˜í™˜</option><option value="ë¶ˆëŸ‰í’ˆ êµí™˜ ì¶œê³ ">ë¶ˆëŸ‰í’ˆ êµí™˜ ì¶œê³ </option></select></div><div class="form-group"><label>ì¶œê³ ì¼</label><input type="date" id="outDate" required></div></div><button onclick="processOutbound()" class="btn btn-warning">ì¶œê³  ì²˜ë¦¬</button></div>
        <div id="move" class="content hidden"><h2>ğŸ”„ ì´ë™ ê´€ë¦¬</h2><div class="form-grid"><div class="form-group"><label>ì œí’ˆ ì„ íƒ</label><input type="text" id="moveProductSelect" list="move_item_list" required><datalist id="move_item_list"></datalist></div><div class="form-group"><label>ì´ë™ ìˆ˜ëŸ‰ (ea)</label><input type="number" id="moveQuantity" min="1"></div><div class="form-group"><label>ìƒˆ êµ¬ì—­</label><select id="moveZone"></select></div><div class="form-group"><label>ìƒˆ ì„¸ë¶€êµ¬ì—­</label><select id="moveSubZone"></select></div><div class="form-group"><label>ìƒˆ ì¸µìˆ˜</label><select id="moveFloor"></select></div><div class="form-group"><label>ì´ë™ì¼</label><input type="date" id="moveDate" required></div></div><button onclick="processMove()" class="btn btn-success">ì´ë™ ì²˜ë¦¬</button></div>
        <div id="warehouse" class="content hidden"><h2>ğŸª ì°½ê³  í˜„í™©</h2><div class="warehouse-grid" id="warehouseStatusGrid"></div></div>
        <div id="layout" class="content hidden"><h2>ğŸ”§ ì°½ê³  êµ¬ì¡° ê´€ë¦¬</h2><div class="form-grid"><div class="form-group"><label for="newZoneName">ìƒˆ êµ¬ì—­ ì´ë¦„</label><input type="text" id="newZoneName" placeholder="ì˜ˆ: Eêµ¬ì—­"><button onclick="addZone()" class="btn btn-primary" style="margin-top:10px;">êµ¬ì—­ ì¶”ê°€</button></div></div><hr style="margin: 20px 0;"><div id="warehouseLayoutContainer"></div></div>
        
        <div id="excel" class="content hidden">
            <div class="excel-section" data-role="admin">
                <h2>1. ìì¬ ëª…ì„¸ì„œ(BOM) ê´€ë¦¬</h2>
                <div class="file-upload" onclick="document.getElementById('bomFileInput').click()">
                    <h3>ğŸ“‹ ìì¬ ëª…ì„¸ì„œ(BOM) ì—…ë¡œë“œ</h3>
                    <p>Aì—´: ì„¤ì¹˜ê°€ì´ë“œëª…, Bì—´: í•„ìš”ë¶€í’ˆì½”ë“œ, Cì—´: í•„ìš”ìˆ˜ëŸ‰ í˜•ì‹ì˜ ì—‘ì…€ íŒŒì¼ì„ ì˜¬ë¦½ë‹ˆë‹¤.</p>
                    <input type="file" id="bomFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="uploadBom(event)">
                </div>
            </div>

            <div class="excel-section" data-role="admin">
                <h2>2. ì œí’ˆ ë§ˆìŠ¤í„° ê´€ë¦¬</h2>
                <div class="file-upload" onclick="document.getElementById('masterFileInput').click()">
                    <h3>ğŸ“‹ ì œí’ˆ ë§ˆìŠ¤í„° ëª©ë¡ ì—…ë¡œë“œ</h3>
                    <p>ì‹œìŠ¤í…œì— ë“±ë¡í•  ì œí’ˆì˜ ê¸°ë³¸ ì •ë³´(ì œí’ˆì½”ë“œ, í’ˆëª…, ë°•ìŠ¤ë‹¹ìˆ˜ëŸ‰)ë¥¼ ì˜¬ë¦½ë‹ˆë‹¤.</p>
                    <input type="file" id="masterFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="uploadMasterList(event)">
                </div>
            </div>

            <div class="excel-section" data-role="admin">
                <h2>3. ì¬ê³  ì¶”ê°€ / ë³´ì¶© (ì•ˆì „)</h2>
                <div class="file-upload" onclick="downloadBlankTemplate()">
                    <h3>ğŸ“„ ë¹ˆ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</h3>
                    <p>ìƒˆë¡œ ì…ê³ ëœ í’ˆëª©ì„ ì¶”ê°€í•˜ê¸° ìœ„í•œ ë¹ˆ í…œí”Œë¦¿ì„ ë°›ìŠµë‹ˆë‹¤.</p>
                </div>
                <div class="file-upload" onclick="document.getElementById('addOrUpdateFileInput').click()">
                    <h3>ğŸšš íŒŒì¼ë¡œ ì¶”ê°€/ë³´ì¶©</h3>
                    <p>ë¹ˆ ì–‘ì‹ì— ì‘ì„±í•œ ì¬ê³ ë¥¼ í˜„ì¬ê³ ì— **ë”í•©ë‹ˆë‹¤.** ê¸°ì¡´ ì¬ê³ ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.</p>
                    <input type="file" id="addOrUpdateFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="uploadForAddOrUpdate(event)">
                </div>
            </div>

            <div class="excel-section" data-role="admin viewer">
                <h2>4. ì¬ê³  ì „ì²´ ë™ê¸°í™” (ì£¼ì˜)</h2>
                <div class="file-upload" data-role="admin viewer" onclick="downloadCurrentInventory()">
                    <h3>ğŸ“Š í˜„ì¬ê³  ì „ì²´ ë‹¤ìš´ë¡œë“œ</h3>
                    <p>ì¬ê³  ì‹¤ì‚¬ ë“±ì„ ìœ„í•´ í˜„ì¬ ì‹œìŠ¤í…œì˜ ëª¨ë“  ì¬ê³  ëª©ë¡ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                </div>
                <div class="file-upload" data-role="admin" onclick="document.getElementById('syncFileInput').click()">
                    <h3>ğŸ”„ íŒŒì¼ë¡œ ì „ì²´ ë™ê¸°í™”</h3>
                    <p>í˜„ì¬ê³  ëª©ë¡ì„ ìˆ˜ì •í•œ íŒŒì¼ë¡œ ì¬ê³  ì „ì²´ë¥¼ **ë®ì–´ì”ë‹ˆë‹¤.** (ì—‘ì…€ì— ì—†ëŠ” í’ˆëª©ì€ 0ì²˜ë¦¬)</p>
                    <input type="file" id="syncFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="uploadForSync(event)">
                </div>
            </div>
             <hr style="margin: 30px 0; border-color: rgba(255,255,255,0.3);">
             <div class="excel-section" style="background-color: rgba(0,0,0,0.1);" data-role="admin">
                <h2>5. ì‹œìŠ¤í…œ ë°ì´í„° ê´€ë¦¬</h2>
                 <div class="file-upload" onclick="backupData()" style="border-color: #ffc107;">
                    <h3>ğŸ’¾ ì „ì²´ ë°ì´í„° ë°±ì—…</h3>
                    <p>í˜„ì¬ ì‹œìŠ¤í…œì˜ ëª¨ë“  ë°ì´í„°(ì¬ê³ ,ì°½ê³ êµ¬ì¡°,ë§ˆìŠ¤í„°)ë¥¼ JSON íŒŒì¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="file-upload" onclick="document.getElementById('restoreFile').click()">
                    <h3>ğŸ“‚ ì „ì²´ ë°ì´í„° ë³µêµ¬</h3>
                    <p>ë°±ì—… íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤. í˜„ì¬ ë°ì´í„°ëŠ” ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
                    <input type="file" id="restoreFile" accept=".json" class="hidden" onchange="restoreData(event)">
                </div>
             </div>
            <div id="uploadResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="adjustmentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì¬ê³  ìˆ˜ëŸ‰ ì¡°ì •</h2>
                <button class="modal-close" onclick="closeAdjustmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ì œí’ˆ ì •ë³´</label>
                    <p id="modalProductInfo" style="font-weight:bold;"></p>
                </div>
                <div class="form-group">
                    <label id="modalQuantityLabel">ìˆ˜ëŸ‰</label>
                    <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                        <label style="cursor:pointer; display:flex; align-items:center;">
                            <input type="radio" name="modalUnitType" value="box" onchange="updateModalQuantityUI()" style="width:auto; margin-right:5px;"> ë°•ìŠ¤ë¡œ ì…ë ¥
                        </label>
                        <label style="cursor:pointer; display:flex; align-items:center;">
                            <input type="radio" name="modalUnitType" value="ea" checked onchange="updateModalQuantityUI()" style="width:auto; margin-right:5px;"> ë‚±ê°œ(EA)ë¡œ ì…ë ¥
                        </label>
                    </div>
                    <div id="modalQuantityInputsContainer"></div>
                </div>
                <div class="form-group">
                    <label for="modalAdjustmentReason">ì¡°ì • ì‚¬ìœ </label>
                    <textarea id="modalAdjustmentReason" rows="3" placeholder="ì˜ˆ: ì¬ê³  ì‹¤ì‚¬ í›„ ì°¨ì´ ë°˜ì˜"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAdjustmentModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveQuantityAdjustment()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="assignLocationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì¬ê³  ìœ„ì¹˜ ì§€ì •</h2>
                <button class="modal-close" onclick="closeAssignLocationModal()">&times;</button>
            </div>
            <div class="modal-body">
                 <div class="form-group">
                    <label>ì œí’ˆ ì •ë³´</label>
                    <p id="assignModalProductInfo" style="font-weight:bold;"></p>
                </div>
                <div class="form-group">
                    <label>ìƒˆ êµ¬ì—­</label>
                    <select id="assignZone" onchange="updateSubZones('assign')"></select>
                </div>
                 <div class="form-group">
                    <label>ìƒˆ ì„¸ë¶€êµ¬ì—­</label>
                    <select id="assignSubZone" onchange="updateFloors('assign')"></select>
                </div>
                 <div class="form-group">
                    <label>ìƒˆ ì¸µìˆ˜</label>
                    <select id="assignFloor"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAssignLocationModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="assignLocation()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="quickAddMasterModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì‹ ê·œ ì œí’ˆ ê°„í¸ ë“±ë¡</h2>
                <button class="modal-close" onclick="closeQuickAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; font-size: 1.1em;">ë§ˆìŠ¤í„° ëª©ë¡ì— ì—†ëŠ” ì œí’ˆì…ë‹ˆë‹¤. ì§€ê¸ˆ ë“±ë¡í•©ë‹ˆë‹¤.</p>
                <div class="form-group">
                    <label>ì œí’ˆì½”ë“œ</label>
                    <p id="modalNewProductCodeInfo" style="font-weight:bold;"></p>
                </div>
                <div class="form-group">
                    <label for="modalNewProductName">í’ˆëª…</label>
                    <input type="text" id="modalNewProductName" required>
                </div>
                <div class="form-group">
                    <label for="modalNewCategory">ì¹´í…Œê³ ë¦¬</label>
                    <select id="modalNewCategory" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="ì „ìì œí’ˆ">ì „ìì œí’ˆ</option><option value="ì˜ë¥˜">ì˜ë¥˜</option><option value="ì‹í’ˆ">ì‹í’ˆ</option><option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option><option value="ì‚°ì—…ìì¬">ì‚°ì—…ìì¬</option><option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalNewBoxSize">ë°•ìŠ¤ë‹¹ ìˆ˜ëŸ‰ (ea)</label>
                    <input type="number" id="modalNewBoxSize" min="1" value="1" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeQuickAddModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="quickAddMasterItem()">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="editMasterModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ë§ˆìŠ¤í„° ì •ë³´ ìˆ˜ì •</h2>
                <button class="modal-close" onclick="closeEditMasterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; font-size: 1em; color: #555;">ì´ í’ˆëª©ì˜ ë§ˆìŠ¤í„° ì •ë³´ê°€ ìˆ˜ì •ë˜ë©°, ë™ì¼í•œ ì œí’ˆì½”ë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ì¬ê³  ëª©ë¡ì— ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                <div class="form-group">
                    <label>ì œí’ˆì½”ë“œ (ìˆ˜ì • ë¶ˆê°€)</label>
                    <p id="editMasterProductCode" style="font-weight:bold;"></p>
                </div>
                <div class="form-group">
                    <label for="editMasterProductName">í’ˆëª…</label>
                    <input type="text" id="editMasterProductName" required>
                </div>
                <div class="form-group">
                    <label for="editMasterCategory">ì¹´í…Œê³ ë¦¬</label>
                    <select id="editMasterCategory" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="ì „ìì œí’ˆ">ì „ìì œí’ˆ</option><option value="ì˜ë¥˜">ì˜ë¥˜</option><option value="ì‹í’ˆ">ì‹í’ˆ</option><option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option><option value="ì‚°ì—…ìì¬">ì‚°ì—…ìì¬</option><option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editMasterBoxSize">ë°•ìŠ¤ë‹¹ ìˆ˜ëŸ‰ (ea)</label>
                    <input type="number" id="editMasterBoxSize" min="1" value="1" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeEditMasterModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveMasterEdit()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">ì´ë™ ì´ë ¥</h2>
                <button class="modal-close" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="historyList"></ul>
            </div>
            <div class="modal-footer">
                <button id="revertLastActionButton" class="btn btn-warning hidden" onclick="">â†©ï¸ ë§ˆì§€ë§‰ ì‘ì—… ë˜ëŒë¦¬ê¸°</button>
                <button class="btn" onclick="closeHistoryModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <div id="exchangeModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¦ êµí™˜ ëŒ€ê¸° ëª©ë¡</h2>
                <button class="modal-close" onclick="closeExchangeModal()">&times;</button>
            </div>
            <div class="modal-body">
                 <div class="table-container">
                    <table id="exchangeTable">
                        <thead><tr><th>ì¶œê³ ì¼</th><th>ì œí’ˆì½”ë“œ</th><th>í’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>ì²˜ë¦¬</th></tr></thead>
                        <tbody id="exchangeBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeExchangeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        "use strict";
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let inventory = [];
        let warehouseLayout = {}; 
        let masterPartList = [];
        let bomData = [];
        let exchangeQueue = []; 
        let currentUserRole = null;
        let nextId = 1;
        const FLOORS = ['1ì¸µ', '2ì¸µ', '3ì¸µ'];
        const USER_ACCOUNTS = { 'admin': { password: 'xormr', role: 'admin' }, 'viewer': { password: '1124', role: 'viewer' } };

        // --- ëª¨ë“  í•¨ìˆ˜ ì •ì˜ ---

        function saveToLocalStorage() { localStorage.setItem('warehouseInventory', JSON.stringify(inventory)); localStorage.setItem('warehouseLayout', JSON.stringify(warehouseLayout)); localStorage.setItem('masterPartList', JSON.stringify(masterPartList)); localStorage.setItem('bomData', JSON.stringify(bomData)); localStorage.setItem('exchangeQueue', JSON.stringify(exchangeQueue)); }
        function loadFromLocalStorage() { 
            const i = localStorage.getItem('warehouseInventory'); if (i) try { inventory = JSON.parse(i); } catch (e) { inventory = []; } 
            const l = localStorage.getItem('warehouseLayout'); if (l) try { warehouseLayout = JSON.parse(l); } catch (e) { warehouseLayout = {}; } 
            const m = localStorage.getItem('masterPartList'); if (m) try { masterPartList = JSON.parse(m); } catch (e) { masterPartList = []; } 
            const b = localStorage.getItem('bomData'); if (b) try { bomData = JSON.parse(b); } catch(e) { bomData = []; }
            const eq = localStorage.getItem('exchangeQueue'); if (eq) try { exchangeQueue = JSON.parse(eq); } catch(e) { exchangeQueue = []; }
        }
        
        function naturalSort(a, b) {
            return new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' }).compare(a, b);
        }
        
        function initializeNextId() {
            if (inventory.length > 0) {
                const maxId = inventory.reduce((max, item) => Math.max(item.id || 0, max), 0);
                nextId = maxId + 1;
            } else {
                nextId = 1;
            }
        }

        function initializeWarehouseLayout() { warehouseLayout = { 'Aêµ¬ì—­': ['A01êµ¬ì—­', 'A02êµ¬ì—­'], 'Bêµ¬ì—­': ['B01êµ¬ì—­', 'B02êµ¬ì—­'] }; }
        function loadSampleData() { 
            inventory = [ 
                { id: nextId++, productCode: 'VF-H', productName: 'ìˆ˜ì§í”„ë ˆì„H', category: 'ì‚°ì—…ìì¬', quantity: 10, location: 'Aêµ¬ì—­-A01êµ¬ì—­-1ì¸µ', status: 'ì¬ê³ ', inDate: '2025-07-03', lastMoveDate: '2025-07-03', boxSize: 1, moveHistory: [{date: '2025-07-03', from: 'ì‹ ê·œì…ê³ ', to: 'Aêµ¬ì—­-A01êµ¬ì—­-1ì¸µ'}] }, 
            ]; 
        }
        function setTodayDate() { const today = new Date().toISOString().split('T')[0]; ['inDate', 'outDate', 'moveDate'].forEach(id => { const el = document.getElementById(id); if (el) el.value = today; }); }
        
        function formatQuantity(quantity, boxSize) {
            if (!boxSize || boxSize <= 1) {
                return `${quantity} ea`;
            }
            const boxes = Math.floor(quantity / boxSize);
            const eaches = quantity % boxSize;
            let displayString = '';

            if (boxes > 0 && eaches > 0) {
                displayString = `${boxes} box - ${eaches} ea`;
            } else if (boxes > 0) {
                displayString = `${boxes} box`;
            } else {
                displayString = `${eaches} ea`;
            }
            return `${displayString} (ì´ ${quantity} ea)`;
        }
        
        function renderInventoryTab(itemsToRender = inventory) {
            const tBody = document.getElementById('inventoryBody');
            const tFoot = document.getElementById('inventoryTfoot');
            if(!tBody || !tFoot) return;
            tBody.innerHTML = '';
            tFoot.innerHTML = '';
            itemsToRender.sort((a,b) => b.id - a.id).forEach(item => {
                const row = tBody.insertRow();
                let locationCell = item.location ? item.location : `<button class="btn btn-info btn-danger-sm" onclick="openAssignLocationModal(${item.id})">[ìœ„ì¹˜ ì§€ì •]</button>`;
                
                let managementCell = '';
                if(currentUserRole === 'admin') {
                    managementCell = `<td><button class="btn btn-warning btn-danger-sm" onclick="openAdjustmentModal(${item.id})">ì¡°ì •</button> <button class="btn btn-danger btn-danger-sm" onclick="deleteItem(${item.id})">ì‚­ì œ</button></td>`;
                } else {
                    managementCell = `<td>-</td>`;
                }

                const editBtn = currentUserRole === 'admin' ? `<button class="btn-edit-master" title="ë§ˆìŠ¤í„° ì •ë³´ ìˆ˜ì •" onclick="openEditMasterModal('${item.productCode}')">âœï¸</button>` : '';

                row.innerHTML = `<td>${item.productCode}</td><td>${item.productName}${editBtn}</td><td>${item.category}</td><td>${formatQuantity(item.quantity, item.boxSize)}</td><td>${locationCell}</td><td><span class="status-badge ${item.quantity > 0 ? 'status-in-stock' : 'status-out-of-stock'}">${item.status}</span></td><td>${item.inDate}</td><td><button class="btn btn-info btn-danger-sm" onclick="showHistory(${item.id})">ì´ë ¥</button></td>${managementCell}`;
            });
            if (itemsToRender.length > 0) {
                const sumQuantity = itemsToRender.reduce((sum, item) => sum + (item.quantity || 0), 0);
                const footRow = tFoot.insertRow();
                footRow.innerHTML = `<td colspan="3" style="text-align:right; font-weight:bold;">í•©ê³„ (ea)</td><td style="font-weight:bold;">${sumQuantity.toLocaleString()}</td><td colspan="5"></td>`;
            }
        }

        function renderOutboundTab() { const datalist = document.getElementById('outbound_item_list'); if(!datalist) return; datalist.innerHTML = ''; inventory.filter(i => i.quantity > 0 && i.location).sort((a,b) => String(a.productName).localeCompare(String(b.productName))).forEach(item => { const qtyText = formatQuantity(item.quantity, item.boxSize); const text = `(${item.productCode}) ${item.location} [${qtyText}]-${item.productName}`; datalist.insertAdjacentHTML('beforeend', `<option value="${text}"></option>`); }); }
        
        function renderMoveTab() {
            const datalist = document.getElementById('move_item_list');
            if (!datalist) return;
            datalist.innerHTML = '';
            inventory.filter(i => i.quantity > 0).sort((a, b) => String(a.productName).localeCompare(String(b.productName))).forEach(item => {
                const qtyText = formatQuantity(item.quantity, item.boxSize);
                const locationText = item.location || 'ìœ„ì¹˜ ë¯¸ì§€ì •';
                const text = `(${item.productCode}) ${locationText} [${qtyText}]-${item.productName}`;
                datalist.insertAdjacentHTML('beforeend', `<option value="${text}"></option>`);
            });
        }
        
        function findItemByText(text) {
            if (!text) return null;
            return inventory.find(i => {
                const qtyText = formatQuantity(i.quantity, i.boxSize);
                const locationText = i.location || 'ìœ„ì¹˜ ë¯¸ì§€ì •';
                const compareText = `(${i.productCode}) ${locationText} [${qtyText}]-${i.productName}`;
                return compareText === text;
            });
        }

        function renderWarehouseLayoutTab() { const container = document.getElementById('warehouseLayoutContainer'); if (!container) return; container.innerHTML = ''; Object.keys(warehouseLayout).sort().forEach(zoneName => { const zoneDiv = document.createElement('div'); zoneDiv.className = 'zone-management'; let subzoneHtml = '<ul class="subzone-list">'; warehouseLayout[zoneName].sort(naturalSort).forEach(subzoneName => { subzoneHtml += `<li><span data-zone="${zoneName}" data-subzone="${subzoneName}">${subzoneName}</span> <div><button class="btn btn-info btn-danger-sm" onclick="editSubzone(this, '${zoneName}', '${subzoneName}')">ìˆ˜ì •</button> <button class="btn btn-danger btn-danger-sm" onclick="deleteSubzone('${zoneName}', '${subzoneName}')">ì‚­ì œ</button></div></li>`; }); subzoneHtml += '</ul>'; zoneDiv.innerHTML = `<h3><span>${zoneName}</span> <button class="btn btn-danger btn-danger-sm" onclick="deleteZone('${zoneName}')">êµ¬ì—­ ì‚­ì œ</button></h3> ${subzoneHtml} <div class="form-group" style="margin-top: 15px;"><input type="text" id="newSubzoneName_${zoneName}" placeholder="ìƒˆ ì„¸ë¶€êµ¬ì—­ ì´ë¦„"><button class="btn btn-primary" style="margin-top: 5px;" onclick="addSubzone('${zoneName}')">ì„¸ë¶€êµ¬ì—­ ì¶”ê°€</button></div>`; container.appendChild(zoneDiv); }); }
        
        function renderWarehouseStatusTab() {
            const grid = document.getElementById('warehouseStatusGrid');
            if (!grid) return;
            grid.innerHTML = '';
            const occupied = {};

            inventory.filter(i => i.quantity > 0 && i.location).forEach(item => {
                const locationString = item.location;
                const firstHyphenIndex = locationString.indexOf('-');
                const lastHyphenIndex = locationString.lastIndexOf('-');

                if (firstHyphenIndex === -1 || lastHyphenIndex === -1 || firstHyphenIndex === lastHyphenIndex) {
                    return; 
                }

                const itemZone = locationString.substring(0, firstHyphenIndex);
                const itemSubzone = locationString.substring(firstHyphenIndex + 1, lastHyphenIndex);
                const itemFloor = locationString.substring(lastHyphenIndex + 1);

                if (!warehouseLayout[itemZone] || !warehouseLayout[itemZone].includes(itemSubzone)) return;

                if (!occupied[itemZone]) occupied[itemZone] = {};
                if (!occupied[itemZone][itemSubzone]) occupied[itemZone][itemSubzone] = new Set();
                
                occupied[itemZone][itemSubzone].add(itemFloor);
            });

            const sortedZones = Object.keys(warehouseLayout).sort();

            sortedZones.forEach(zone => {
                const card = document.createElement('div');
                card.className = 'zone-card';
                card.innerHTML = `<div class="zone-title">${zone}</div>`;
                
                warehouseLayout[zone].sort(naturalSort).forEach(subZone => {
                    const subzoneItem = document.createElement('div');
                    subzoneItem.className = 'subzone-item';
                    
                    let floorBadgesHTML = '';
                    FLOORS.forEach(floor => {
                        const isOccupied = occupied[zone] && occupied[zone][subZone] && occupied[zone][subZone].has(floor);
                        floorBadgesHTML += `<span class="floor-badge ${isOccupied ? 'occupied' : 'vacant'}">${floor}</span>`;
                    });

                    subzoneItem.innerHTML = `<div class="subzone-title">${subZone}</div><div class="floor-badges">${floorBadgesHTML}</div>`;
                    card.appendChild(subzoneItem);
                });
                grid.appendChild(card);
            });
        }
        
        function renderBomCheckTab() {
            const guideSelect = document.getElementById('guideSelect');
            if(!guideSelect) return;
            guideSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            const guideNames = [...new Set(bomData.map(item => item.guideName))];
            guideNames.sort(naturalSort).forEach(name => {
                guideSelect.add(new Option(name, name));
            });
            checkBom();
        }

        function updateDatalists() { const codeDL = document.getElementById('product_code_list'); const nameDL = document.getElementById('product_name_list'); if (!codeDL || !nameDL) return; codeDL.innerHTML = ''; nameDL.innerHTML = ''; const unique = new Map(); masterPartList.forEach(p => { if (!unique.has(p.code)) unique.set(p.code, {name: p.name, boxSize: p.boxSize}); }); unique.forEach((val, code) => { codeDL.insertAdjacentHTML('beforeend', `<option value="${code}"></option>`); nameDL.insertAdjacentHTML('beforeend', `<option value="${val.name}">${code}</option>`); }); }
        function updateZoneDropdowns(prefix) { const select = document.getElementById(`${prefix}Zone`); if (!select) return; const currentVal = select.value; select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; Object.keys(warehouseLayout).sort().forEach(z => select.add(new Option(z, z))); if (warehouseLayout[currentVal]) select.value = currentVal; else select.value = ""; }
        function updateAllSubZoneDropdowns() { updateSubZones('in'); updateSubZones('move'); updateSubZones('assign');}
        
        function updateSubZones(prefix) { const zoneSelect = document.getElementById(`${prefix}Zone`); const subZoneSelect = document.getElementById(`${prefix}SubZone`); if(!zoneSelect || !subZoneSelect) return; const currentVal = subZoneSelect.value; subZoneSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; const selectedZone = zoneSelect.value; if (selectedZone && warehouseLayout[selectedZone]) { warehouseLayout[selectedZone].sort(naturalSort).forEach(sz => subZoneSelect.add(new Option(sz, sz))); } if(warehouseLayout[selectedZone]?.includes(currentVal)) subZoneSelect.value = currentVal; else subZoneSelect.value = ""; updateFloors(prefix); }
        function updateFloors(prefix) { const subZoneSelect = document.getElementById(`${prefix}SubZone`); const floorSelect = document.getElementById(`${prefix}Floor`); if(!subZoneSelect || !floorSelect) return; floorSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'; if(subZoneSelect.value){ FLOORS.forEach(f => floorSelect.add(new Option(f, f))); } }
        function updateStats() { const inStock = inventory.filter(i => i.quantity > 0); document.getElementById('totalItems').textContent = inStock.reduce((s, i) => s + (i.quantity || 0), 0).toLocaleString(); document.getElementById('inStockItems').textContent = new Set(inStock.map(i => i.productCode)).size.toLocaleString(); document.getElementById('outStockCount').textContent = inventory.filter(i => i.status === 'ì¶œê³ ì™„ë£Œ').length.toLocaleString(); document.getElementById('occupiedLocations').textContent = new Set(inStock.map(i => i.location).filter(Boolean)).size.toLocaleString(); }
        
        function showTab(event) {
            const tabName = event.currentTarget.dataset.tab;
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.remove('hidden');
            event.currentTarget.classList.add('active');

            if (tabName === 'inventory') renderInventoryTab();
            if (tabName === 'outbound') renderOutboundTab();
            if (tabName === 'move') renderMoveTab();
            if (tabName === 'warehouse') renderWarehouseStatusTab();
            if (tabName === 'layout') renderWarehouseLayoutTab();
            if (tabName === 'bomCheck') renderBomCheckTab();
        }

        function filterInventory(e) { const searchTerm = e.target.value.toLowerCase(); const filtered = inventory.filter(item => String(item.productCode).toLowerCase().includes(searchTerm) || String(item.productName).toLowerCase().includes(searchTerm) || String(item.category).toLowerCase().includes(searchTerm)); renderInventoryTab(filtered); }
        function addZone() { const input = document.getElementById('newZoneName'); const newZoneName = input.value.trim(); if (newZoneName && !warehouseLayout[newZoneName]) { warehouseLayout[newZoneName] = []; runAllUpdates(); input.value = ''; } else { alert('ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ êµ¬ì—­ ì´ë¦„ì…ë‹ˆë‹¤.'); } }
        function deleteZone(zoneName) { if (isLocationInUse(zoneName)) { alert(`'${zoneName}'ì— ì¬ê³ ê°€ ì¡´ì¬í•˜ì—¬ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; } if (confirm(`'${zoneName}' êµ¬ì—­ê³¼ ëª¨ë“  í•˜ìœ„ êµ¬ì—­ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { delete warehouseLayout[zoneName]; runAllUpdates(); } }
        
        function editSubzone(button, zoneName, oldSubzoneName) {
            const span = button.parentElement.previousElementSibling;
            const currentName = span.textContent;
            
            span.innerHTML = `<input type="text" value="${currentName}" style="width: 120px;"/>`;
            button.textContent = 'ì €ì¥';
            button.onclick = () => saveSubzone(zoneName, oldSubzoneName);
        }

        function saveSubzone(zoneName, oldSubzoneName) {
            const span = document.querySelector(`span[data-subzone="${oldSubzoneName}"]`);
            const input = span.querySelector('input');
            const newSubzoneName = input.value.trim();

            if (!newSubzoneName) {
                alert('ì„¸ë¶€êµ¬ì—­ ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (newSubzoneName !== oldSubzoneName && warehouseLayout[zoneName].includes(newSubzoneName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„¸ë¶€êµ¬ì—­ ì´ë¦„ì…ë‹ˆë‹¤.');
                return;
            }

            const subzoneIndex = warehouseLayout[zoneName].indexOf(oldSubzoneName);
            if (subzoneIndex > -1) {
                warehouseLayout[zoneName][subzoneIndex] = newSubzoneName;
            }

            inventory.forEach(item => {
                if (!item.location) return;
                const firstHyphenIndex = item.location.indexOf('-');
                const lastHyphenIndex = item.location.lastIndexOf('-');
                if (firstHyphenIndex === -1 || lastHyphenIndex === -1) return;

                const itemZone = item.location.substring(0, firstHyphenIndex);
                const itemSubzone = item.location.substring(firstHyphenIndex + 1, lastHyphenIndex);
                const itemFloor = item.location.substring(lastHyphenIndex + 1);

                if (itemZone === zoneName && itemSubzone === oldSubzoneName) {
                    item.location = `${zoneName}-${newSubzoneName}-${itemFloor}`;
                }
            });

            alert(`'${oldSubzoneName}'ì´(ê°€) '${newSubzoneName}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë ¨ ì¬ê³  ìœ„ì¹˜ë„ ëª¨ë‘ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            runAllUpdates();
        }


        function addSubzone(zoneName) { const input = document.getElementById(`newSubzoneName_${zoneName}`); const newSubzoneName = input.value.trim(); if (newSubzoneName && !warehouseLayout[zoneName].includes(newSubzoneName)) { warehouseLayout[zoneName].push(newSubzoneName); runAllUpdates(); } else { alert('ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ë¶€êµ¬ì—­ ì´ë¦„ì…ë‹ˆë‹¤.'); } }
        function deleteSubzone(zoneName, subzoneName) { if (isLocationInUse(zoneName, subzoneName)) { alert(`'${subzoneName}'ì— ì¬ê³ ê°€ ì¡´ì¬í•˜ì—¬ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; } if (confirm(`'${subzoneName}' ì„¸ë¶€êµ¬ì—­ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { warehouseLayout[zoneName] = warehouseLayout[zoneName].filter(sz => sz !== subzoneName); runAllUpdates(); } }
        
        function isLocationInUse(zone, subzone = null) {
            return inventory.some(item => {
                if (!item.location || item.quantity <= 0) return false;

                const locationString = item.location;
                const firstHyphenIndex = locationString.indexOf('-');
                const lastHyphenIndex = locationString.lastIndexOf('-');

                if (firstHyphenIndex === -1 || lastHyphenIndex === -1 || firstHyphenIndex === lastHyphenIndex) {
                    return false;
                }

                const itemZone = locationString.substring(0, firstHyphenIndex);
                if (subzone) {
                    const itemSubzone = locationString.substring(firstHyphenIndex + 1, lastHyphenIndex);
                    return itemZone === zone && itemSubzone === subzone;
                }
                return itemZone === zone;
            });
        }
        
        // --- (ì´í•˜ ëª¨ë“  JavaScript í•¨ìˆ˜ë“¤) ---
        // ëª¨ë“  í•¨ìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ ì™„ì „í•œ ì½”ë“œë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
        
        function checkBom() {
            const guideName = document.getElementById('guideSelect').value;
            const bomBody = document.getElementById('bomBody');
            bomBody.innerHTML = '';

            if (!guideName) return;

            const requiredParts = bomData.filter(item => item.guideName === guideName);

            requiredParts.forEach(part => {
                const bomPartCode = String(part.partCode).trim();
                const masterItem = masterPartList.find(m => String(m.code).trim() === bomPartCode);
                const productName = masterItem ? masterItem.name : '<strong class="status-shortage">&lt;ë§ˆìŠ¤í„°ì— ë“±ë¡ í•„ìš”&gt;</strong>';
                
                const currentStock = inventory
                    .filter(inv => String(inv.productCode).trim() === bomPartCode)
                    .reduce((total, inv) => total + inv.quantity, 0);
                
                const requiredQty = parseInt(part.requiredQty, 10);
                const status = currentStock >= requiredQty ? '<span class="status-ok">â— ì¶©ë¶„</span>' : `<span class="status-shortage">â—ï¸ ë¶€ì¡± (${requiredQty - currentStock}ê°œ)</span>`;

                const row = bomBody.insertRow();
                row.innerHTML = `<td>${part.partCode}</td><td>${productName}</td><td>${requiredQty}</td><td>${currentStock}</td><td>${status}</td>`;
            });
        }

        function handleInboundSubmit(e) { e.preventDefault(); const productCode = document.getElementById('inProductCode').value.trim(); const product = masterPartList.find(p => String(p.code) === productCode); if (!product) { alert('ë§ˆìŠ¤í„° ëª©ë¡ì— ì—†ëŠ” ì œí’ˆì½”ë“œì…ë‹ˆë‹¤. ë¨¼ì € ì œí’ˆ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.\n(ì œí’ˆì½”ë“œ ì…ë ¥ í›„ ë‹¤ë¥¸ ì¹¸ì„ í´ë¦­í•˜ë©´ ê°„í¸ ë“±ë¡ íŒì—…ì´ ëœ¹ë‹ˆë‹¤.)'); return; } let totalQuantity = 0; const selectedUnit = document.querySelector('input[name="inboundUnitType"]:checked').value; if (selectedUnit === 'box' && product.boxSize > 1) { const boxQty = parseInt(document.getElementById('inBoxQuantity').value) || 0; const eaQty = parseInt(document.getElementById('inEaQuantity').value) || 0; totalQuantity = (boxQty * product.boxSize) + eaQty; } else { const quantityInput = document.getElementById('inQuantity'); totalQuantity = quantityInput ? (parseInt(quantityInput.value) || 0) : 0; } if (totalQuantity <= 0) { alert('ìˆ˜ëŸ‰ì„ 1 ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } const formData = { productCode: productCode, productName: document.getElementById('inProductName').value.trim(), category: document.getElementById('inCategory').value, quantity: totalQuantity, boxSize: product.boxSize, zone: document.getElementById('inZone').value, subZone: document.getElementById('inSubZone').value, floor: document.getElementById('inFloor').value, inDate: document.getElementById('inDate').value }; if (!formData.productName || !formData.category || !formData.zone || !formData.subZone || !formData.floor || !formData.inDate) { alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } const location = `${formData.zone}-${formData.subZone}-${formData.floor}`; const existingItem = inventory.find(item => String(item.productCode) === productCode && item.location === location); if (existingItem) { existingItem.quantity += formData.quantity; if(!existingItem.moveHistory) existingItem.moveHistory = []; existingItem.moveHistory.push({ date: formData.inDate, from: 'ì¶”ê°€ì…ê³ ', to: location, qty: formData.quantity }); existingItem.lastMoveDate = formData.inDate; } else { inventory.push({ id: nextId++, ...formData, location: location, status: 'ì¬ê³ ', lastMoveDate: formData.inDate, outDate: null, moveHistory: [{date: formData.inDate, from: 'ì‹ ê·œì…ê³ ', to: location, qty: formData.quantity}] }); } alert('ì…ê³  ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); document.getElementById('inboundForm').reset(); updateInboundQuantityUI(true); runAllUpdates(); }
        function processOutbound() { const selectedText = document.getElementById('outProductSelect').value; const item = findItemByText(selectedText); const quantity = parseInt(document.getElementById('outQuantity').value); const outDate = document.getElementById('outDate').value; const reason = document.getElementById('outReason').value; if (!item || !quantity || !outDate) return alert('ëª¨ë“  í•„ë“œë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. ì œí’ˆì€ ëª©ë¡ì—ì„œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.'); if (quantity > item.quantity) return alert('ì¶œê³  ìˆ˜ëŸ‰ì´ ì¬ê³ ëŸ‰ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.'); if (!item.moveHistory) item.moveHistory = []; const historyRecord = { date: outDate, qty: quantity, from: item.location }; switch (reason) { case 'ì¡°ë¦½ì¥ ì´ë™': item.quantity -= quantity; historyRecord.to = 'ì¡°ë¦½ì¥ ì´ë™'; historyRecord.type = 'outbound'; break; case 'ì¶œê³  ë°˜í™˜': item.quantity += quantity; historyRecord.from = 'ë°˜í™˜ì…ê³ '; historyRecord.to = item.location; historyRecord.type = 'return'; break; case 'ë¶ˆëŸ‰í’ˆ êµí™˜ ì¶œê³ ': item.quantity -= quantity; historyRecord.to = 'ë¶ˆëŸ‰í’ˆ êµí™˜ ì¶œê³ '; historyRecord.type = 'exchange-out'; const txId = Date.now() + '-' + Math.random(); historyRecord.txId = txId; exchangeQueue.push({ txId: txId, itemId: item.id, productCode: item.productCode, productName: item.productName, qty: quantity, date: outDate }); break; } item.moveHistory.push(historyRecord); item.lastMoveDate = outDate; if (item.quantity <= 0) { item.status = 'ì¶œê³ ì™„ë£Œ'; item.outDate = outDate; } else { item.status = 'ì¬ê³ '; item.outDate = null; } alert(`'${reason}' ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`); document.getElementById('outProductSelect').value = ''; document.getElementById('outQuantity').value = ''; runAllUpdates(); }
        function processMove() { const selectedText = document.getElementById('moveProductSelect').value; const fromItem = findItemByText(selectedText); if (!fromItem) return alert('ì œí’ˆ ëª©ë¡ì—ì„œ ì´ë™í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); const quantity = parseInt(document.getElementById('moveQuantity').value); const newZone = document.getElementById('moveZone').value; const newSubZone = document.getElementById('moveSubZone').value; const newFloor = document.getElementById('moveFloor').value; const moveDate = document.getElementById('moveDate').value; if (!quantity || !newZone || !newSubZone || !newFloor || !moveDate) return alert('ì´ë™í•  ìˆ˜ëŸ‰, ìƒˆ ìœ„ì¹˜, ì´ë™ì¼ì„ ëª¨ë‘ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.'); if (quantity > fromItem.quantity) return alert('ì´ë™ ìˆ˜ëŸ‰ì´ ì¬ê³ ëŸ‰ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.'); const newLocation = `${newZone}-${newSubZone}-${newFloor}`; const oldLocation = fromItem.location || 'ìœ„ì¹˜ ë¯¸ì§€ì •'; let toItem = inventory.find(i => String(i.productCode) === String(fromItem.productCode) && i.location === newLocation); if (fromItem.location === newLocation && fromItem.location !== null) return alert('í˜„ì¬ ìœ„ì¹˜ì™€ ë™ì¼í•œ ìœ„ì¹˜ë¡œëŠ” ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); const txId = Date.now() + '-' + Math.random(); if (toItem) { toItem.quantity += quantity; if (!toItem.moveHistory) toItem.moveHistory = []; toItem.moveHistory.push({ date: moveDate, from: oldLocation, to: newLocation, qty: quantity, type: 'move-in', txId: txId }); toItem.lastMoveDate = moveDate; fromItem.quantity -= quantity; if (!fromItem.moveHistory) fromItem.moveHistory = []; fromItem.moveHistory.push({ date: moveDate, from: oldLocation, to: newLocation, qty: quantity, type: 'move-out', txId: txId }); if(fromItem.quantity <= 0) { fromItem.status = 'ì¶œê³ ì™„ë£Œ'; } } else { if (fromItem.quantity > quantity) { fromItem.quantity -= quantity; if (!fromItem.moveHistory) fromItem.moveHistory = []; fromItem.moveHistory.push({ date: moveDate, from: oldLocation, to: newLocation, qty: quantity, type: 'move-out', txId: txId }); const newItem = { ...fromItem, id: nextId++, quantity: quantity, location: newLocation, lastMoveDate: moveDate, moveHistory: [{ date: moveDate, from: oldLocation, to: newLocation, qty: quantity, type: 'move-in', txId: txId }]}; inventory.push(newItem); } else { fromItem.location = newLocation; if (!fromItem.moveHistory) fromItem.moveHistory = []; fromItem.moveHistory.push({ date: moveDate, from: oldLocation, to: newLocation, qty: quantity, type: 'move-full', txId: txId }); fromItem.lastMoveDate = moveDate; } } alert('ì´ë™(ìœ„ì¹˜ì§€ì •) ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); document.getElementById('moveProductSelect').value = ''; document.getElementById('moveQuantity').value = ''; runAllUpdates(); }
        function deleteItem(itemId) { if (currentUserRole !== 'admin') return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); if (confirm('ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { inventory = inventory.filter(item => item.id != itemId); runAllUpdates(); alert('í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); } }
        function showHistory(itemId) { const item = inventory.find(i => i.id == itemId); if (!item || !item.moveHistory) { alert('ì´ë ¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; } const modal = document.getElementById('historyModal'); document.getElementById('historyModalTitle').textContent = `'${item.productName}' ì´ë™ ì´ë ¥`; const list = document.getElementById('historyList'); list.innerHTML = ''; item.moveHistory.forEach(h => { let baseString = `[${h.date}] ${h.from} â†’ ${h.to}`; if (h.qty !== undefined) { baseString += ` (${h.qty} ea)`; } if (h.reason) { baseString += ` (ì‚¬ìœ : ${h.reason})`; } const li = document.createElement('li'); li.textContent = baseString; list.prepend(li); }); const revertButton = document.getElementById('revertLastActionButton'); const lastAction = item.moveHistory[item.moveHistory.length - 1]; const cancellableActionTypes = ['outbound', 'return', 'move-in', 'move-out', 'move-full']; if (currentUserRole === 'admin' && lastAction && cancellableActionTypes.includes(lastAction.type)) { revertButton.classList.remove('hidden'); revertButton.onclick = () => revertLastAction(item.id, lastAction.type); } else { revertButton.classList.add('hidden'); } modal.classList.remove('hidden'); }
        function closeHistoryModal() { document.getElementById('historyModal').classList.add('hidden'); }
        function revertLastAction(itemId, actionType) { const item = inventory.find(i => i.id == itemId); if (!item || !item.moveHistory || item.moveHistory.length === 0) { alert('ë˜ëŒë¦´ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.'); return; } const lastAction = item.moveHistory[item.moveHistory.length - 1]; if (actionType === 'outbound' || actionType === 'return') { if (!confirm('ë§ˆì§€ë§‰ ì¶œê³ /ë°˜í™˜ ì‘ì—…ì„ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return; item.moveHistory.pop(); if (lastAction.type === 'outbound') item.quantity += lastAction.qty; if (lastAction.type === 'return') item.quantity -= lastAction.qty; } else if (actionType.startsWith('move')) { if (!confirm('ë§ˆì§€ë§‰ ì´ë™ ì‘ì—…ì„ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return; const { txId, qty, from } = lastAction; item.moveHistory.pop(); const involvedItems = inventory.filter(i => i.moveHistory && i.moveHistory.some(h => h.txId === txId)); if (involvedItems.length === 0 && lastAction.type === 'move-full') { item.location = from; } else { const sourceItem = inventory.find(i => i.location === from && i.productCode === item.productCode); const destItem = item; if (!sourceItem) { alert('ì˜¤ë¥˜: ì´ë™ ì‘ì—…ì„ ë˜ëŒë¦¬ëŠ” ë° í•„ìš”í•œ ì›ë˜ ìœ„ì¹˜ì˜ í’ˆëª©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); item.moveHistory.push(lastAction); return; } sourceItem.quantity += qty; destItem.quantity -= qty; sourceItem.moveHistory = sourceItem.moveHistory.filter(h => h.txId !== txId); destItem.moveHistory = destItem.moveHistory.filter(h => h.txId !== txId); if (destItem.quantity <= 0 && destItem.moveHistory.length === 0) { inventory = inventory.filter(i => i.id !== destItem.id); } } } else { alert('ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } inventory.forEach(i => { if(i.id === item.id) { if (i.quantity > 0) { i.status = 'ì¬ê³ '; if (i.outDate) i.outDate = null; } } }); alert('ë§ˆì§€ë§‰ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ë˜ëŒë ¤ì¡ŒìŠµë‹ˆë‹¤.'); closeHistoryModal(); runAllUpdates(); }
        function loadProductForOut() { const item = findItemByText(document.getElementById('outProductSelect').value); if(item) document.getElementById('outQuantity').max = item.quantity; }
        function loadProductForMove() { const item = findItemByText(document.getElementById('moveProductSelect').value); if(item) document.getElementById('moveQuantity').max = item.quantity; }
        function syncMasterData(event) { const codeInput = document.getElementById('inProductCode'); const nameInput = document.getElementById('inProductName'); const categoryInput = document.getElementById('inCategory'); if (event.target.id === 'inProductCode') { const p = masterPartList.find(part => String(part.code) === event.target.value); if (p) { nameInput.value = p.name; if(p.category) categoryInput.value = p.category; } } else if (event.target.id === 'inProductName') { const p = masterPartList.find(part => part.name === event.target.value); if (p) { codeInput.value = p.code; if(p.category) categoryInput.value = p.category; } } updateInboundQuantityUI(true); }
        function uploadBom(event) { const file = event.target.files[0]; const resultDiv = document.getElementById('uploadResult'); resultDiv.innerHTML = ''; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: ['guideName', 'partCode', 'requiredQty'] }); if (!confirm(`${jsonData.length -1} ê±´ì˜ BOM ë°ì´í„°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ BOM ë°ì´í„°ëŠ” ì‚­ì œë©ë‹ˆë‹¤.`)) { return; } bomData = jsonData.slice(1).map(row => ({ ...row, partCode: String(row.partCode || '').trim() })).filter(row => row.guideName && row.partCode && row.requiredQty); runAllUpdates(); const message = `BOM ì—…ë¡œë“œ ì™„ë£Œ! ì´ ${bomData.length}ê±´ì˜ ë°ì´í„°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`; resultDiv.innerHTML = `<p style="color: green;">${message}</p>`; alert(message); } catch (error) { resultDiv.innerHTML = `<p style="color: red;">BOM ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`; } finally { event.target.value = ''; } }; reader.readAsArrayBuffer(file); }
        function uploadMasterList(event) { const file = event.target.files[0]; const resultDiv = document.getElementById('uploadResult'); resultDiv.innerHTML = ''; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); if (jsonData.length < 1) throw new Error("ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); let newItemsCount = 0; let updatedItemsCount = 0; jsonData.slice(1).forEach(row => { const code = String(row[0] || '').trim(); if (!code) return; const name = String(row[1] || code).trim(); const boxSize = parseInt(row[2] || '1', 10) || 1; const existingItem = masterPartList.find(p => String(p.code) === code); if (existingItem) { existingItem.name = name; existingItem.boxSize = boxSize; updatedItemsCount++; } else { masterPartList.push({ code, name, boxSize }); newItemsCount++; } }); runAllUpdates(); let message = 'ë§ˆìŠ¤í„° ëª©ë¡ ì—…ë¡œë“œ ì™„ë£Œ!'; if (newItemsCount > 0 || updatedItemsCount > 0) { message += ` (ì‹ ê·œ ì¶”ê°€: ${newItemsCount}ê±´, ì •ë³´ ì—…ë°ì´íŠ¸: ${updatedItemsCount}ê±´)`; } else { message = 'ì²˜ë¦¬í•  ìƒˆë¡œìš´ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'; } resultDiv.innerHTML = `<p style="color: green;">${message}</p>`; alert(message); } catch (error) { resultDiv.innerHTML = `<p style="color: red;">ë§ˆìŠ¤í„° ëª©ë¡ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`; } finally { event.target.value = ''; } }; reader.readAsArrayBuffer(file); }
        function uploadForAddOrUpdate(event) { const file = event.target.files[0]; const resultDiv = document.getElementById('uploadResult'); resultDiv.innerHTML = ''; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(worksheet); let updatedCount = 0; let addedCount = 0; let skippedCount = 0; jsonData.forEach(row => { const productCode = String(row.productCode || '').trim(); const location = String(row.location || '').trim(); const quantity = parseInt(row.quantity, 10); if (!productCode || isNaN(quantity) || quantity <= 0) { skippedCount++; return; } const itemToUpdate = inventory.find(invItem => String(invItem.productCode) === productCode && (invItem.location || null) === (location || null)); if (itemToUpdate) { itemToUpdate.quantity += quantity; if (!itemToUpdate.moveHistory) itemToUpdate.moveHistory = []; itemToUpdate.moveHistory.push({ date: new Date().toISOString().split('T')[0], from: 'ì—‘ì…€ë³´ì¶©', to: location || 'ìœ„ì¹˜ ë¯¸ì§€ì •', qty: quantity }); updatedCount++; } else { const product = masterPartList.find(p => String(p.code) === productCode); if (!product) { skippedCount++; return; } inventory.push({ id: nextId++, productCode: productCode, productName: String(row.productName || product.name), category: String(row.category || 'ê¸°íƒ€'), quantity: quantity, boxSize: product.boxSize, location: location || null, inDate: new Date().toISOString().split('T')[0], status: 'ì¬ê³ ', lastMoveDate: new Date().toISOString().split('T')[0], outDate: null, moveHistory: [{ date: new Date().toISOString().split('T')[0], from: 'ì—‘ì…€ì¶”ê°€', to: location || 'ìœ„ì¹˜ ë¯¸ì§€ì •', qty: quantity }] }); addedCount++; } }); runAllUpdates(); const message = `ì¬ê³  ì¶”ê°€/ë³´ì¶© ì™„ë£Œ! (ì‹ ê·œ: ${addedCount}ê±´, ë³´ì¶©: ${updatedCount}ê±´, ê±´ë„ˆëœ€: ${skippedCount}ê±´)`; resultDiv.innerHTML = `<p style="color: green;">${message}</p>`; alert(message); } catch (error) { resultDiv.innerHTML = `<p style="color: red;">ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`; } finally { event.target.value = ''; } }; reader.readAsArrayBuffer(file); }
        function uploadForSync(event) { const file = event.target.files[0]; const resultDiv = document.getElementById('uploadResult'); resultDiv.innerHTML = ''; if (!file) return; if (!confirm("ê²½ê³ : ì´ ì‘ì—…ì€ í˜„ì¬ ì¬ê³  ë°ì´í„°ë¥¼ ì—‘ì…€ íŒŒì¼ì˜ ë‚´ìš©ìœ¼ë¡œ ì™„ì „íˆ ë®ì–´ì”ë‹ˆë‹¤.\nì—‘ì…€ì— ì—†ëŠ” í’ˆëª©ì€ ì¬ê³ ê°€ 0ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.\nì •ë§ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const excelData = XLSX.utils.sheet_to_json(worksheet); let updatedCount = 0, addedCount = 0, zeroedCount = 0, skippedCount = 0; let newInventory = []; const excelItems = new Map(); excelData.forEach(row => { const productCode = String(row.productCode || '').trim(); const location = String(row.location || '').trim(); const quantity = parseInt(row.quantity, 10); if (!productCode || isNaN(quantity)) { skippedCount++; return; } const key = `${productCode}@@${location}`; excelItems.set(key, row); }); inventory.forEach(currentItem => { const key = `${currentItem.productCode}@@${currentItem.location || ''}`; const excelRow = excelItems.get(key); if (excelRow) { const quantity = parseInt(excelRow.quantity, 10); if (!isNaN(quantity)) { currentItem.quantity = quantity; currentItem.status = quantity > 0 ? 'ì¬ê³ ' : 'ì¶œê³ ì™„ë£Œ'; updatedCount++; } newInventory.push(currentItem); excelItems.delete(key); } else { currentItem.quantity = 0; currentItem.status = 'ì¶œê³ ì™„ë£Œ'; zeroedCount++; newInventory.push(currentItem); } }); excelItems.forEach(row => { const productCode = String(row.productCode || '').trim(); const location = String(row.location || '').trim(); const quantity = parseInt(row.quantity, 10); if (!productCode || isNaN(quantity)) return; const product = masterPartList.find(p => String(p.code) === productCode); if (!product) { skippedCount++; return; } addedCount++; newInventory.push({ id: nextId++, productCode: productCode, productName: String(row.productName || product.name), category: String(row.category || 'ê¸°íƒ€'), quantity: quantity, boxSize: product.boxSize, location: location || null, inDate: new Date().toISOString().split('T')[0], status: quantity > 0 ? 'ì¬ê³ ' : 'ì¶œê³ ì™„ë£Œ', lastMoveDate: new Date().toISOString().split('T')[0], outDate: quantity > 0 ? null : new Date().toISOString().split('T')[0], moveHistory: [{ date: new Date().toISOString().split('T')[0], from: 'ì—‘ì…€ë™ê¸°í™”', to: location || 'ìœ„ì¹˜ ë¯¸ì§€ì •', qty: quantity }] }); }); inventory = newInventory; runAllUpdates(); const message = `ì¬ê³  ì „ì²´ ë™ê¸°í™” ì™„ë£Œ! (ì‹ ê·œ: ${addedCount}ê±´, ì—…ë°ì´íŠ¸: ${updatedCount}ê±´, ì¬ê³  0 ì²˜ë¦¬: ${zeroedCount}ê±´, ê±´ë„ˆëœ€: ${skippedCount}ê±´)`; resultDiv.innerHTML = `<p style="color: green;">${message}</p>`; alert(message); } catch (error) { resultDiv.innerHTML = `<p style="color: red;">ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`; } finally { event.target.value = ''; } }; reader.readAsArrayBuffer(file); }
        function downloadCurrentInventory() { const dataToExport = inventory.map(item => ({ productCode: String(item.productCode), productName: String(item.productName), category: String(item.category), quantity: item.quantity, location: item.location || '', inDate: item.inDate, status: item.status })); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'ì¬ê³ í˜„í™©'); worksheet['!cols'] = [ { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 25 }, { wch: 12 }, { wch: 12 } ]; XLSX.writeFile(workbook, `í˜„ì¬ê³ _ì „ì²´ëª©ë¡_${new Date().toISOString().slice(0,10)}.xlsx`); }
        function downloadBlankTemplate() { const headers = [["productCode", "productName", "category", "quantity", "location", "inDate", "status"]]; const worksheet = XLSX.utils.aoa_to_sheet(headers); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'ì¬ê³ ì¶”ê°€ì–‘ì‹'); worksheet['!cols'] = [ { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 25 }, { wch: 12 }, { wch: 12 } ]; XLSX.writeFile(workbook, 'ì¬ê³ ì¶”ê°€_ë¹ˆ_ì–‘ì‹.xlsx'); }
        function backupData() { if(!confirm('í˜„ì¬ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; const backup = { inventory, warehouseLayout, masterPartList, bomData, exchangeQueue }; const dataStr = JSON.stringify(backup, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `warehouse_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); }
        function restoreData(event) { const file = event.target.files[0]; if (!file) return; if(!confirm('ë°±ì—… íŒŒì¼ë¡œ í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  í˜„ì¬ ì‘ì—… ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.inventory && data.warehouseLayout && data.masterPartList) { inventory = data.inventory; warehouseLayout = data.warehouseLayout; masterPartList = data.masterPartList; bomData = data.bomData || []; exchangeQueue = data.exchangeQueue || []; const restoredInventoryCount = inventory.length; const restoredLayoutCount = Object.keys(warehouseLayout).length; const restoredMasterCount = masterPartList.length; initializeNextId(); runAllUpdates(); const message = `ë°ì´í„° ë³µêµ¬ ì™„ë£Œ! (ì¬ê³  í•­ëª©: ${restoredInventoryCount}ê±´, ì°½ê³  êµ¬ì—­: ${restoredLayoutCount}ê±´, ë§ˆìŠ¤í„° í’ˆëª©: ${restoredMasterCount}ê±´)`; alert(message); } else { throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); } } catch (error) { alert(`ë³µì› ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`); } finally { event.target.value = ''; } }; reader.readAsText(file); }
        function openAdjustmentModal(itemId) { if (currentUserRole !== 'admin') return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); const modal = document.getElementById('adjustmentModal'); const item = inventory.find(i => i.id === itemId); if (!item) return; modal.dataset.editingItemId = itemId; document.getElementById('modalProductInfo').textContent = `${item.productName} (${item.productCode})`; document.getElementById('modalAdjustmentReason').value = ''; updateModalQuantityUI(item); modal.classList.remove('hidden'); }
        function closeAdjustmentModal() { document.getElementById('adjustmentModal').classList.add('hidden'); }
        function updateModalQuantityUI(item) { const container = document.getElementById('modalQuantityInputsContainer'); const label = document.getElementById('modalQuantityLabel'); const boxSize = item ? item.boxSize : 1; document.querySelector(`input[name="modalUnitType"][value="${boxSize > 1 ? 'box' : 'ea'}"]`).checked = true; let displayUnit = document.querySelector('input[name="modalUnitType"]:checked').value; if (displayUnit === 'box' && boxSize <= 1) { displayUnit = 'ea'; document.querySelector(`input[name="modalUnitType"][value="ea"]`).checked = true; } container.innerHTML = ''; if (displayUnit === 'box') { label.textContent = 'ì¡°ì • ìˆ˜ëŸ‰ (ë°•ìŠ¤/ë‚±ê°œ)'; const currentBoxes = Math.floor(item.quantity / boxSize); const currentEaches = item.quantity % boxSize; container.innerHTML = `<div style="display: flex; gap: 10px;"><input type="number" id="modalBoxQuantity" placeholder="ë°•ìŠ¤" min="0" value="${currentBoxes}" style="flex: 1;"><input type="number" id="modalEaQuantity" placeholder="ë‚±ê°œ" min="0" value="${currentEaches}" style="flex: 1;"></div>`; } else { label.textContent = 'ì¡°ì • ìˆ˜ëŸ‰ (EA)'; container.innerHTML = `<input type="number" id="modalQuantity" placeholder="ì´ ë‚±ê°œ ìˆ˜ëŸ‰" min="0" value="${item.quantity}" required>`; } }
        function saveQuantityAdjustment() { if (currentUserRole !== 'admin') return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); const modal = document.getElementById('adjustmentModal'); const itemId = parseInt(modal.dataset.editingItemId); const item = inventory.find(i => i.id === itemId); if (!item) return; const reason = document.getElementById('modalAdjustmentReason').value.trim(); if (!reason) { alert('ì¡°ì • ì‚¬ìœ ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } const oldQty = item.quantity; let newTotalQuantity = 0; const selectedUnit = document.querySelector('input[name="modalUnitType"]:checked').value; if (selectedUnit === 'box' && item.boxSize > 1) { const boxQty = parseInt(document.getElementById('modalBoxQuantity').value) || 0; const eaQty = parseInt(document.getElementById('modalEaQuantity').value) || 0; newTotalQuantity = (boxQty * item.boxSize) + eaQty; } else { const quantityInput = document.getElementById('modalQuantity'); newTotalQuantity = quantityInput ? (parseInt(quantityInput.value) || 0) : 0; } if (newTotalQuantity < 0) { alert('ìˆ˜ëŸ‰ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; } if (newTotalQuantity > 0) { item.status = 'ì¬ê³ '; } else { item.status = 'ì¶œê³ ì™„ë£Œ'; item.outDate = new Date().toISOString().split('T')[0]; } item.quantity = newTotalQuantity; item.lastMoveDate = new Date().toISOString().split('T')[0]; if (!item.moveHistory) item.moveHistory = []; item.moveHistory.push({ date: item.lastMoveDate, from: 'ì¬ê³ ì¡°ì •', to: `ìˆ˜ëŸ‰ ë³€ê²½: ${oldQty} â†’ ${newTotalQuantity}`, reason: reason }); closeAdjustmentModal(); runAllUpdates(); alert('ìˆ˜ëŸ‰ ì¡°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        function openAssignLocationModal(itemId) { if (currentUserRole !== 'admin') return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); const modal = document.getElementById('assignLocationModal'); const item = inventory.find(i => i.id === itemId); if (!item) return; modal.dataset.editingItemId = itemId; document.getElementById('assignModalProductInfo').textContent = `${item.productName} (${item.productCode})`; updateZoneDropdowns('assign'); updateSubZones('assign'); updateFloors('assign'); modal.classList.remove('hidden'); }
        function closeAssignLocationModal() { document.getElementById('assignLocationModal').classList.add('hidden'); }
        function assignLocation() { if (currentUserRole !== 'admin') return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); const modal = document.getElementById('assignLocationModal'); const itemId = parseInt(modal.dataset.editingItemId); const item = inventory.find(i => i.id === itemId); if (!item) return; const newZone = document.getElementById('assignZone').value; const newSubZone = document.getElementById('assignSubZone').value; const newFloor = document.getElementById('assignFloor').value; if (!newZone || !newSubZone || !newFloor) { alert('ìƒˆë¡œìš´ ìœ„ì¹˜ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; } const newLocation = `${newZone}-${newSubZone}-${newFloor}`; const oldLocation = item.location || 'ìœ„ì¹˜ ë¯¸ì§€ì •'; item.location = newLocation; if (!item.moveHistory) item.moveHistory = []; item.moveHistory.push({ date: new Date().toISOString().split('T')[0], from: oldLocation, to: newLocation, reason: 'ìœ„ì¹˜ ì§€ì •' }); closeAssignLocationModal(); runAllUpdates(); alert('ìœ„ì¹˜ ì§€ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        function handleProductCodeBlur(event) { const productCode = event.target.value.trim(); if (!productCode) return; const exists = masterPartList.some(p => p.code === productCode); if (!exists) { openQuickAddModal(productCode); } }
        function openQuickAddModal(productCode) { const modal = document.getElementById('quickAddMasterModal'); document.getElementById('modalNewProductCodeInfo').textContent = productCode; document.getElementById('modalNewProductName').value = ''; document.getElementById('modalNewCategory').value = ''; document.getElementById('modalNewBoxSize').value = '1'; modal.classList.remove('hidden'); document.getElementById('modalNewProductName').focus(); }
        function closeQuickAddModal() { document.getElementById('quickAddMasterModal').classList.add('hidden'); }
        function quickAddMasterItem() { const productCode = document.getElementById('modalNewProductCodeInfo').textContent; const productName = document.getElementById('modalNewProductName').value.trim(); const category = document.getElementById('modalNewCategory').value; const boxSize = parseInt(document.getElementById('modalNewBoxSize').value, 10) || 1; if (!productName || !category) { alert('í’ˆëª…ê³¼ ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } masterPartList.push({ code: productCode, name: productName, boxSize: boxSize, category: category }); document.getElementById('inProductCode').value = productCode; document.getElementById('inProductName').value = productName; document.getElementById('inCategory').value = category; alert(`'${productName}'(${productCode}) ì œí’ˆì´ ë§ˆìŠ¤í„°ì— ì‹ ê·œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nê³„ì†í•´ì„œ ì…ê³ ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.`); closeQuickAddModal(); runAllUpdates(); }
        function openEditMasterModal(productCode) { const masterItem = masterPartList.find(p => p.code === productCode); if(!masterItem) { alert('ë§ˆìŠ¤í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } const modal = document.getElementById('editMasterModal'); document.getElementById('editMasterProductCode').textContent = masterItem.code; document.getElementById('editMasterProductName').value = masterItem.name; document.getElementById('editMasterCategory').value = masterItem.category || ''; document.getElementById('editMasterBoxSize').value = masterItem.boxSize || 1; modal.classList.remove('hidden'); document.getElementById('editMasterProductName').focus(); }
        function closeEditMasterModal() { document.getElementById('editMasterModal').classList.add('hidden'); }
        function saveMasterEdit() { const productCode = document.getElementById('editMasterProductCode').textContent; const masterItem = masterPartList.find(p => p.code === productCode); if(!masterItem) { alert('ì˜¤ë¥˜: ìˆ˜ì •í•  ë§ˆìŠ¤í„° ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; } const newName = document.getElementById('editMasterProductName').value.trim(); const newCategory = document.getElementById('editMasterCategory').value; const newBoxSize = parseInt(document.getElementById('editMasterBoxSize').value, 10) || 1; if (!newName || !newCategory) { alert('í’ˆëª…ê³¼ ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } masterItem.name = newName; masterItem.category = newCategory; masterItem.boxSize = newBoxSize; inventory.forEach(item => { if(item.productCode === productCode) { item.productName = newName; item.category = newCategory; } }); alert('ë§ˆìŠ¤í„° ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); closeEditMasterModal(); runAllUpdates(); }
        function openExchangeModal() { const modal = document.getElementById('exchangeModal'); const tableBody = document.getElementById('exchangeBody'); tableBody.innerHTML = ''; if (exchangeQueue.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">êµí™˜ ëŒ€ê¸° ì¤‘ì¸ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; } else { exchangeQueue.forEach((item, index) => { const row = tableBody.insertRow(); row.innerHTML = ` <td>${item.date}</td> <td>${item.productCode}</td> <td>${item.productName}</td> <td>${item.qty}</td> <td><button class="btn btn-success btn-danger-sm" onclick="completeExchange(${index})">ì…ê³  ì™„ë£Œ</button></td> `; }); } modal.classList.remove('hidden'); }
        function closeExchangeModal() { document.getElementById('exchangeModal').classList.add('hidden'); }
        function completeExchange(queueIndex) { if (!confirm('ì´ êµí™˜ ê±´ì„ ì…ê³  ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; const exchangeItemInfo = exchangeQueue[queueIndex]; if (!exchangeItemInfo) { alert('ì˜¤ë¥˜: êµí™˜ ëŒ€ê¸° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } const originalItem = inventory.find(i => i.id === exchangeItemInfo.itemId); if (originalItem) { originalItem.quantity += exchangeItemInfo.qty; if (!originalItem.moveHistory) originalItem.moveHistory = []; originalItem.moveHistory.push({ date: new Date().toISOString().split('T')[0], from: 'êµí™˜ì…ê³ ', to: originalItem.location, qty: exchangeItemInfo.qty, type: 'exchange-in', txId: exchangeItemInfo.txId }); if(originalItem.quantity > 0){ originalItem.status = 'ì¬ê³ '; originalItem.outDate = null; } } exchangeQueue.splice(queueIndex, 1); closeExchangeModal(); runAllUpdates(); alert('êµí™˜í’ˆ ì…ê³  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        
        // --- ë¡œê·¸ì¸ ë° ì•± ì‹œì‘ ---
        function runAllUpdates() { renderInventoryTab(); renderOutboundTab(); renderMoveTab(); renderWarehouseLayoutTab(); renderWarehouseStatusTab(); updateZoneDropdowns('in'); updateZoneDropdowns('move'); updateAllSubZoneDropdowns(); updateDatalists(); updateStats(); setTodayDate(); saveToLocalStorage(); renderBomCheckTab();}
        
        function applyUIPermissions() {
            document.querySelectorAll('[data-role]').forEach(element => {
                const roles = element.dataset.role.split(' ');
                if (!roles.includes(currentUserRole)) {
                    element.classList.add('hidden');
                } else {
                    element.classList.remove('hidden');
                }
            });

            const excelTab = document.querySelector('.tab[data-tab="excel"]');
            if (excelTab) {
                const visibleExcelSections = document.querySelectorAll('#excel .excel-section:not(.hidden)');
                if (visibleExcelSections.length === 0) {
                    excelTab.classList.add('hidden');
                }
            }
        }
        
        function attachAllEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', showTab));
            document.getElementById('searchInput').addEventListener('input', filterInventory); 
            document.getElementById('inboundForm').addEventListener('submit', handleInboundSubmit); 
            document.getElementById('inProductCode').addEventListener('input', syncMasterData);
            document.getElementById('inProductCode').addEventListener('blur', handleProductCodeBlur);
            document.getElementById('inProductName').addEventListener('input', syncMasterData); 
            document.getElementById('outProductSelect').addEventListener('input', loadProductForOut); 
            document.getElementById('moveProductSelect').addEventListener('input', loadProductForMove); 
            ['in', 'move', 'assign'].forEach(p => { 
                const zoneSelect = document.getElementById(`${p}Zone`);
                if(zoneSelect) {
                    zoneSelect.addEventListener('change', () => updateSubZones(p)); 
                }
                const subZoneSelect = document.getElementById(`${p}SubZone`);
                if(subZoneSelect) {
                    subZoneSelect.addEventListener('change', () => updateFloors(p));
                }
            }); 
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            const account = USER_ACCOUNTS[username];
            if (account && account.password === password) {
                currentUserRole = account.role;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                
                loadFromLocalStorage();
                initializeNextId();
                
                if (Object.keys(warehouseLayout).length === 0) initializeWarehouseLayout();
                if (inventory.length === 0) {
                    loadSampleData();
                    initializeNextId();
                }
                
                applyUIPermissions();
                attachAllEventListeners();
                runAllUpdates(); 
                
                const firstTab = document.querySelector('.tab:not(.hidden)');
                if(firstTab) {
                    firstTab.click(); 
                }
                updateInboundQuantityUI(true);
            } else {
                errorDiv.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                setTimeout(() => { errorDiv.textContent = ''; }, 3000);
            }
        }
        function logout() { if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { location.reload(); } }
        
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });
    </script>
</body>
</html>